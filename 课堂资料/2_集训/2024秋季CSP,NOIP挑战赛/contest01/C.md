# $V\le 21$

注意到两个相同的数相乘可以互相抵消掉，所以每个数可分类成**选奇数个**和**选偶数个**两种状态，选奇数个可以看成选一个，选偶数个可以看成不选，那么最大的乘积只有 $V!=51090942171709440000$，可用 `__int128` 存下，判断是否为完全平方数只需要试除 $1\sim V$ 内的所有质数平方因子即可。

时间复杂度：$O(2^V\times V)$。

# $V\le 33$

注意到 $\mu(i)=0$（即含平方因子）的数可以通过不断除以平方因子做到与 $\mu(i)\not=0$ 的数本质相同，所以无需考虑 $\mu(i)=0$ 的数。而 $V$ 以内的 $\mu(i)\not=0$ 个数最多只有 $21$ 个，最大的乘积也只有 $30051520145226019440000$，也可以用 `__int128` 存下。

时间复杂度：$O\left(2^{\sum\limits_{i=1}^V|\mu(i)|}\times \sum\limits_{i=1}^V|\mu(i)|\right)$

# $V\le 69$

注意到 $\mu(i)\not=0$ 可以表示成若干个质数（且次数均为 $1$）相乘，而 $\omega(V)\le 19$，所以每个数的质因数分解状态可以用 $19$ 位的二进制数来表示，完全平方数要求选择的若干数所代表的状态的**异或和** $=0$，直接跑 状压dp 即可。设 $f_{i,S}$ 代表 $1\sim i$ 内的所有数中选一些数使得这些数所代表的状态的异或和为 $S$ 的方案数，转移是平凡的。

时间复杂度：$O\left(2^{\omega(V)}\sum\limits_{i=1}^V|\mu(i)|\right)$

# $V\le 139$

注意到选奇数个 $>\dfrac V2$ 的质数**没有任何意义**，所以这部分直接让答案乘上选偶数个 $>\dfrac V2$ 的质数的方案数即可。

时间复杂度：$O\left(2^{\omega(\frac V2)}\sum\limits_{i=1}^{\frac V2}|\mu(i)|\right)$

# $V\le 312$

考虑设阈值 $B$ 然后折半，当一个数不存在 $>B$ 的质数的时候跑状压 dp，存在 $>B$ 的质数的数很少，可以暴力搜索这些数每个数选奇数个还是选偶数个。

当 $B$ 取 $69$ 时，一共有 $43$ 个数存在 $>69$ 的质数，其中质数在 $[71,103]$ 之间的有 $p,2p,3p$，这部分的质数个数有 $8$ 个，质数在 $(103,156]$ 之间的有 $p,2p$，这部分的质数个数有 $9$ 个，所以有效的搜索量只有 $4^8\times 2^9=2^{25}=33554432$，可以通过。

# $V\le 4021$

考虑根号分治，由于将一个数质因数分解后只存在一个 $>\sqrt V$ 的质数，所以可以根据这个质数是什么（或不存在）分类，每一类必须选择偶数个数，然后将 $<\sqrt V$ 的质数状压做 dp 即可，由于每一类要选择恰好偶数个数，所以要在原来的 dp 基础上多开一维 $0/1$ 代表该类数选了奇数个还是偶数个。

由于 $\omega(\sqrt V)\le 18$，且第 $18$ 个质数 $61$ 因为有 $61\times 67=4087>V$，所以可以把 $61$ 也看成大质数，所以质数只有 $17$ 个，$2^{17}=131072,\sum\limits_{i=1}^V|\mu(i)|\le 2446$，二者相乘为 $320602112≈3.2\times 10^8$。

$V\le 1234$ 给想出根号分治但是实现的复杂度较劣的算法，例如对每一维单独做背包然后合并，使用了快速幂求转移时候的 $2$ 的幂次等等。

时间复杂度：$O\left(2^{\omega(\sqrt V)}\sum\limits_{i=1}^V|\mu(i)|\right)$

# $V\le 5123$

按照 $V\le 4021$ 的思路，小质数有 $19$ 个，$2^{19}=524288,\sum\limits_{i=1}^V|\mu(i)|\le 3115$，二者相乘为 $1633157120≈1.63\times 10^9$ 很难过去。

但是我们发现，大质数很大的时候，小质数就只能很小，所以我们可以先枚举较大的大质数类，这样做状压 dp 的时候 $S$ 只需要开到很小的范围即可，当枚举的大质数不断变小的时候，$S$ 再不断变大直至 $[0,2^{19})$ 范围，经测试，该做法的耗时不到上面做法的 $\dfrac 15$，可以通过。

由于选奇数/偶数个数的方案数均需要用的 $2$ 的幂次，而由于 $\mu(i)=0$ 的 $b_i$ 会加到 $\mu(i)\not=0$ 的 $b_i$ 中，所以最大的 $b_i$ 如 $b_1$ 可以达到 $10^5\times \sqrt V\le 7.1\times10^6$，所以你需要预处理 $7.1\times 10^6$ 以内的 $2$ 的次幂。

# Bonus：$V\le 10^6$

drdilyor Orz 把标算给踩了。

我们发现当 $b_i>0$ 时选奇数个和选偶数个方案数一样，这其实就是个固定的系数。

而选择若干个数使得异或和为 $0$ 的方案数，这其实就是 $2$ 的把它们插进线性基里的自由元个数次幂。

再套用根号分治以及上述优化外加线性基本就支持的 bitset 优化，可以做到：$O\left(\dfrac{V^2}{\omega\ln^2V}\right)$，常数极小，毛估估一下可以过 $10^6$。