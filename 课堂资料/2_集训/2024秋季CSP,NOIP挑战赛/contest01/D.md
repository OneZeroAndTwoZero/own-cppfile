# $n\le 100,m=1,k\le 8$

相当于只有第一行的数互不相同，以及第一列的两个数要求不相同。

如果只考虑第一条限制，那么因为要求所有格子异或和为 $0$，无论第一行怎么选第二行都有且仅有一种情况使得所有格子异或和为 $0$，所以这部分的方案数为 $(2^k)^\underline{n}$。

但是这样第一行的的两个格子的值可能会相同，这也就意味着剩下的 $n-1$ 个格子的值互不相同且异或和为 $0$，可以按值域顺序 dp，设 $f_{i,j,S}$ 为 $1\sim i$ 中选了 $j$ 个数异或和为 $S$ 的方案数，转移是平凡的。

时间复杂度：$O(Tn\times 4^k)$

# $m=1$

设 $f_i$ 为 $i$ 个不同 $k$ 位二进制数（有序）使得异或和为 $0$ 的方案数，那么先随便钦定前 $i-1$ 个 $k$ 位二进制数这样第 $i$ 个二进制数也就确定了，总方案数为 $(2^k)^\underline{i-1}$。但是可能会出现第 $i$ 个二进制数和其中某个二进制数相同的情况，这种需要减去，除去这两个数还剩下 $i-2$ 个数，这 $i-2$ 个数是互不相同的且异或和为 $0$，方案数为 $f_{i-2}$，由于第 $i$ 个数不能和其它 $i-2$ 个数相同，所以可选的方案数共有 $2^k-i+2$ 种，同时与第 $i$ 个数相同的位置还不确定，所以还需要乘上 $i-1$。由此可以得出 $f_i$ 的递推式：
$$
f_0=f_1=1\\f_i=(2^k)^\underline{i-1}-f_{i-2}\times(2^k-i+2)\times(i-1)\ (i\ge 2)
$$
若第二行的某个格子和第一行的某个格子的值相同，则称这两个格子配对，显然这两个格子不能处在同一列。

关于 $m=1$ 还有一种做法，对第二行的第一个格子是否与第一行的某个格子配对分类讨论。

1. 若第二行的第一个格子不与第一行的任何格子配对，则这 $n+1$ 个数均不相同，方案数为 $f_{n+1}$。
2. 若第二行的第一个格子与第一行的某个格子配对，则剩下的 $n-1$ 个格子均不相同且异或和为 $0$，这部分方案数为 $f_{n-1}$，第二行的第一个格子跟任意一个格子都可以相同，方案数为 $n-1$，这一对格子必须和剩下的 $n-1$ 个格子不相同，方案数为 $2^k-n+1$，所以总方案数为 $f_{n-1}\times(n-1)\times(2^k-n+1)$。

最后将二者方案数加起来即可。

时间复杂度：$O(Tn)$。

# $m\le 7$

还是枚举第二行的格子是否与第一行的格子配对以及跟第一行的哪个格子配对，但因为配对要求位置错排。所以第二行的格子与第一行的前  $m$ 个格子配对可能会影响之后的格子配对的选择空间，故可以将第二行每个格子的配对种类分为 $m+2$ 种：不配对，与前 $m$ 个格子的其中一个配对，与前 $m$ 个格子之后的格子（本质相同）配对，设成功配对了 $x$ 对，其中有 $y$ 对是跟第一行前 $m$ 个格子之后的格子配对的，则方案数为 $f_{n+m-2x}\times (2^k-(n+m-2x))^\underline{x}\times (n-m)^\underline y$。

预处理 $2^k$ 的下降幂及其逆元（这部分需要线性），阶乘及其逆元即可 $O(1)$ 算出方案数。

设 $F(m)$ 为本质不同的配对方案数（其中 $F(7)=362384$），则时间复杂度为：$O(T(F(m)+n))$

# $m=n+1$

**此做法跟正解没有关联。**

这说明一个很重要的性质：$n+m$ 是奇数！

思考一下，假设当前纸条的所有格子的值的异或和为 $x$，那么给所有格子均异或上 $x$，总异或和也会异或上 $x$ 从而变成 $0$，相同行，列之间的互不相同条件该满足还是会满足。

显然对于每种总异或和，满足相同行，列之间的互不相同条件的方案数一定相等，所以我们只需要统计出满足互不相同条件的方案数最后除以 $2^k$ 就是答案。

我们先可以填好第二行，方案数为 $(2^k)^\underline m$，第一行考虑容斥，设 $f(S)$ 为只有集合 $S$ 内的每一列元素相同的方案数，$g(T)$ 为钦定集合 $T$ 内的每一列元素相同的方案数，则有：
$$
f(S)=\sum_{S\subseteq T\subseteq\{1,2,\dots,n\}}(-1)^{|T|-|S|}g(T)
$$
显然对于相同的 $|T|$，$g(T)$ 必然相同，则满足条件的第一行的方案数为：
$$
f(\empty)=\sum_{T\subseteq\{1,2,\dots,n\}}(-1)^{|T|}g(T)=\sum_{i=0}^n(-1)^i\binom ni(2^k-i)^\underline{n-i}
$$
时间复杂度：$O(T(n+m))$

# 正解

在 $m\le 7$ 的做法中我们发现其实只需要关心**成功配对了多少对**以及**每类被认为本质相同的配对方案一共有多少种**。

在这里我们认为**两个配对方案本质相同**当且仅当**配对的对数相同**，所以不妨枚举成功配对了 $i$ 对，本质相同的配对方案数为 $d_i$ 种，那么方案数则为 $f_{n+m-2i}\times (2^k-(n+m-2i))^\underline i\times \dbinom m i\times d_i$。

设 $g_i$ 为有多少 $n$ 阶排列 $[p_1,p_2,\dots,p_n]$ 满足对于 $1\le j\le i$ 都有 $p_j\not=j$ 的方案数（类似错排状物），则 $d_i=\dfrac{g_i}{(n-i)!}$。

这里不妨认为 $n\ge m$，则 $g_n=D(n)$，考虑倒着递推，若现在需要从 $g_i$ 递推到 $g_{i-1}$，有两种情况：

1. 若 $p_i\not=i$ 则方案数刚好为 $g_i$。
2. 若 $p_i=i$ 则可以直接把 $p_i$ 删除，方案数为有多少 $n-1$ 阶排列 $[p_1,p_2,\dots,p_{n-1}]$ 满足对于 $1\le j\le i-1$ 都有 $p_j\not=j$ 的方案数，设其为 $h_i$。

由此可以得出 $g_{i-1}=g_i+h_i$。

现在考虑 $h_i$ 如何递推，关于普通错排有一个经典公式： $D(n)=(n-1)(D(n-1)+D(n-2))$，做法是 $p_{p_n}$ 是否 $=n$ 分类讨论：

1. 若 $p_{p_n}=n$，则问题变成了大小为 $n-2$ 的错排问题，方案数为 $D(n-2)$。
2. 若 $p_{p_n}\not=n$，则问题变成长度为 $n-1$ 的排列中，对于任意的 $1\le i\le n-1$ 都需要满足 $p_i\not=i$，这是大小为 $n-1$ 的错排问题，方案数为 $D(n-1)$。

因为 $p_n$ 的取值有 $n-1$ 种，所以 $D(n)=(n-1)(D(n-1)+D(n-2))$。

那么拓展一下，设 $D(n,m)$ 为长度为 $n$ 的排列，前 $m$ 个元素要求错排的方案数。

那么做法还是一样，设 $p_x=m\ (x\not=m)$，则删掉 $p_m$ 之后需要让 $p_x$ 继承原来的 $p_m$，接下来对 $x$ 的大小分类讨论：

1. 若 $x<m$（这样的 $x$ 共有 $m-1$ 种），则可能会导致 $p_x=x$，但这并没有关系，我们可以不强制 $p_x\not=x$，这样问题变成了长度为 $n-1$ 的排列，前 $m-2$ 个元素要求错排的方案数，即 $D(n-1,m-2)$。
2. 若 $x>m$（这样的 $x$ 共有 $n-m$ 种），则无论 $p_x$ 是否 $=x$ 其实没影响，因为此前我们并没有强制 $p_x\not=x$，这样问题变成了长度为 $n-1$ 的排列，前 $m-1$ 个元素要求错排的方案数，即 $D(n-1,m-1)$。

由此我们可以得出递推式 $D(n,m)=(n-m)\times D(n-1,m-1)+(m-1)\times D(n-1,m-2)$，转化成 $g_i,h_i$ 的关系式就是：
$$
g_i=(n-i)\times h_i+(i-1)\times h_{i-1}
$$
由此可以得出根据 $g_i,h_i$ 递推出 $h_{i-1}$ 的关系式：$h_i=\dfrac{g_i-(n-i)h_i}{i-1}$。

综上，可以得出如下的 $g_i,h_i$ 递推式：
$$
g_{i-1}=g_i+h_i\\h_i=\dfrac{g_i-(n-i)h_i}{i-1}
$$
可以在 $O(n)$ 时间内得出所有 $g_i,h_i$，进而得到所有 $d_i$。

时间复杂度：$O(T(n+m))$

时限开的比较松，只要写的是严格线性做法应该都能过，如果用 $O(\log \text{mod})$ 在线处理逆元只会被卡成 $88$ 分。

